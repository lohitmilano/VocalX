// Affiliate Program Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin users who can access the affiliate dashboard
model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String   // bcrypt hashed
  role      String   @default("admin") // admin, manager, viewer
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

// Affiliate partners
model Affiliate {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  website      String?
  affiliateTier String  @default("silver") // silver, gold, platinum
  status       String   @default("pending") // pending, active, inactive, suspended
  uniqueSlug   String   @unique // for tracking links: ?ref=SLUG
  referralLink String   // generated link
  
  // Bank details for manual payouts (encrypted JSON)
  bankDetails  Json?
  
  // Commission rates by tier
  commissionRate Decimal @default(15.00) @db.Decimal(5, 2) // percentage
  
  // Tracking
  totalReferrals    Int     @default(0)
  totalRevenue      Decimal @default(0) @db.Decimal(10, 2)
  totalCommissions  Decimal @default(0) @db.Decimal(10, 2)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  customers        Customer[]
  commissionEvents CommissionEvent[]
  payouts          Payout[]
  
  @@map("affiliates")
}

// Customers referred by affiliates
model Customer {
  id               String    @id @default(uuid())
  email            String    @unique
  stripeCustomerId String?   @unique
  affiliateId      String?
  attributedAt     DateTime? // when affiliate attribution was confirmed
  
  // Tracking data
  referralSource   String? // UTM source
  ipAddress        String?
  userAgent        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  affiliate        Affiliate? @relation(fields: [affiliateId], references: [id])
  commissionEvents CommissionEvent[]
  
  @@map("customers")
}

// Individual commission events from Stripe payments
model CommissionEvent {
  id               String   @id @default(uuid())
  affiliateId      String
  customerId       String
  stripeChargeId   String   @unique
  stripeEventId    String   @unique // for idempotency
  
  // Financial data
  chargeAmount     Decimal  @db.Decimal(10, 2)
  commissionRate   Decimal  @db.Decimal(5, 2) // percentage at time of event
  commissionAmount Decimal  @db.Decimal(10, 2)
  
  // Event metadata
  eventType        String   // charge.succeeded, charge.refunded
  status           String   @default("confirmed") // confirmed, refunded, disputed
  monthYear        String   // YYYY-MM for grouping
  
  // Stripe metadata
  stripeMetadata   Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  affiliate Affiliate @relation(fields: [affiliateId], references: [id])
  customer  Customer  @relation(fields: [customerId], references: [id])
  
  @@index([affiliateId])
  @@index([customerId])
  @@index([monthYear])
  @@map("commission_events")
}

// Monthly payouts to affiliates
model Payout {
  id              String    @id @default(uuid())
  affiliateId     String
  payoutMonth     String    // YYYY-MM
  totalCommission Decimal   @db.Decimal(10, 2)
  status          String    @default("pending") // pending, approved, paid, failed
  paymentMethod   String    @default("bank_transfer") // bank_transfer, stripe_connect
  
  // Payment tracking
  paidAt          DateTime?
  transactionId   String?   // bank transfer reference
  notes           String?
  
  // Approval workflow
  approvedBy      String?   // admin ID
  approvedAt      DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  affiliate Affiliate @relation(fields: [affiliateId], references: [id])
  
  @@unique([affiliateId, payoutMonth])
  @@index([payoutMonth])
  @@map("payouts")
}

// Stripe webhook event logs for debugging
model WebhookLog {
  id            String   @id @default(uuid())
  eventType     String
  stripeEventId String   @unique
  payload       Json
  processed     Boolean  @default(false)
  errorMessage  String?
  
  createdAt DateTime @default(now())
  
  @@index([stripeEventId])
  @@index([processed])
  @@map("webhook_logs")
}

// System settings and configuration
model Setting {
  id    String @id @default(uuid())
  key   String @unique
  value String
  
  updatedAt DateTime @updatedAt
  
  @@map("settings")
}
